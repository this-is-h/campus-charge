# NXU Charge PHP

这里是 `PHP` 服务器的示例

### 配置

1. 配置 `MySQL`

    ```php
    ···
    $servername = "your server name"; // 127.0.0.1:3306
    $username = "your username"; // root
    $password = "your password"; // 123456
    $connname = "your con name"; // test
    ···
    ```

2. 获取 `clientid`

    使用抓包工具抓取访问接口时请求头中的clientid参数

### 使用

本文件夹包含 3 项功能，5 个文件

* #### 准备 - `pre.php`

    该文件会在数据库内创建带有初始数据的所有数据表。
    结构如下：

    ```
    DATABASE
    ├─c14
    ├─a2
    ├─b10
    │ └─以上均为各充电桩数据
    ├─···
    └─data
        └─包括更新时间，是否正在更新等数据
    ```

    ##### 其中充电桩数据表如下：

    |    id    |       1       |       2       |      ···      |      10       |
    | -------- | ------------- | ------------- | ------------- | ------------- |
    | 88227164 | 1702492680000 | 1702492680000 | 1702492680000 | 1702492680000 |
    | ·······  | ·······       | ·······       | ·······       | ·······       |

    `id` 为充电桩的编号；1 - 10 为其10个端口；储存的数据为结束充电的毫秒级时间戳

    ##### data数据表如下：

    | id|    num   |   timestamp   | using |                 token                   |
    | - | -------- | ------------- | ----- | --------------------------------------- |
    | 1 | 38351121 | 1702483033936 |   0   | 32c8eb48ce4ce065f24309cd942bdba691405a1f|

    `num` 为官方接口中的 `seepower_pid` 参数；`using` 为是否正在更新数据，以防止上一次更新尚未结束时开始下一次更新；`token` 为爬取到的token参数。

* #### 更新数据 - update.php

    该文件会更新所有充电桩数据。

    ##### 更新逻辑

    ###### 官方接口解析

    `https://h5.2ye.cn/api/chargerlog/power?seepower_pid=37916860`

    其中 `seepower_pid` 应该为一个系统编号，每当有充电桩成功启动时，该值加 1 。
    当编号对应的订单存在时，接口返回值中含有充电开始时间 `start_date` 和 购买的充电时长 `total_time`，二者相加即为结束时间；当编号对应的订单不存在时，接口会返回如下数据：
    
    ```json
    {
        "err_code": 502,
        "err_msg": "记录不存在",
        "data": []
    }
    ```

    ###### 数据展示
    在展示页使用当时的时间减去储存的结束时间，即得剩余时间，如果差值小于0，则已经结束，判定为空闲即可。

    ###### 更新数据

    更新时，取得上次结束的 `seepower_pid` 值，进入循环，在访问得到数据时保持循环，如果返回了“记录不存在”的记录，则退出循环。

    ###### 存在的问题

    该接口存在一个问题，即第一次访问时（刚创建订单时），获取到的只有开始时间和持续时间，仅能以此推断结束时间。但实际情况常为充电完成或是人为拔下插头导致提前结束，此时如再次以该参数访问接口，可以得到结束时间。但是，数据每分钟更新一次，每分钟产生的订单数在高峰期可能成百上千，如果再对每一个端口的状态重新访问，既对官方接口造成极大压力，也延长了运行时间。
    如何解决？可以参考下面一节的内容。

* #### 获取数据

    在获取数据前，我们先来介绍一下另一个官方接口

    `https://h5.2ye.cn/api/charger/port`

    **该接口需要携带body，参数为 `productid`（充电桩编号），示例值 `88230806`**
    **该接口请求头中需要携带 `token`，token有效期似乎为一个月**

    该接口返回该充电桩当前所有端口的状态信息，但是不包含剩余时间。
    
    于是我们采取在获取数据时，获取所需充电桩的端口状态，覆盖原有数据。
    > 注意，这只是一个**临时办法**，不仅增加了获取数据的时间，在访问人数大的情况下也加剧了官方服务器的压力。但是由于真实空闲情况比倒计时重要的多，我们在暂未有更好办法之前，不得不临时采用该办法。

    ##### 文件说明

    由于虚拟主机的限制，该功能提供了三个文件

    * ##### get-data_none.php

        该文件只获取数据库的数据，不获取最新状态及覆盖。
        在未来我们可能会采取更新数据时即覆盖的情况，届时可能会采用该文件。

    * ##### get-data_update.php（当前）

        该文件在获取数据库的数据时，同时获取最新状态及覆盖。

    * ##### get-data_multi.php

        该文件与上一文件相同，但使用 `curl_multi` 提高获取速度。
        由于虚拟主机限制，无法使用该文件。

### 碎碎念

由于目前使用的是华为云函数工作流的免费额度更新数据，国外免费虚拟主机托管网站，总是有很多很多的限制导致很多想法不能实现，后续会考虑购买国内服务器搭建的...。

还有，`PHP` 是世界上最好的编程语言。
